<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Translation Result</title>
    <style>
        /* --- GIAO DI·ªÜN G·ªêC (GI·ªÆ NGUY√äN) --- */
        /* Ch·ªß ƒë·ªÅ s√°ng/t·ªëi */
        :root {
            --primary-color: #1E90FF;
            --text-color: #0E1117;
            --bg-color: #ffffff;
            --block-bg: #ffffff;
            --block-border: #e6e6e6;
            --control-bg: #0E1117;
            --control-text: #ffffff;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --text-color: #ffffff;
                --bg-color: #1E1E1E;
                --block-bg: #2d2d2d;
                --block-border: #3d3d3d;
                --control-bg: #2d2d2d; /* Fix l·∫°i cho ƒë·∫πp h∆°n */
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
        }

        /* Khung ch·ª©a n·ªôi dung d·ªãch */
        .translation-block {
            background: var(--block-bg);
            border: 1px solid var(--block-border);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .sentence-part {
            margin-bottom: 2em;
            padding: 10px;
            border-bottom: 1px dashed var(--block-border);
        }

        /* --- M√ÄU S·∫ÆC ƒê·∫∂C TR∆ØNG --- */
        .original { 
            font-weight: bold; font-size: 1.1em; margin-bottom: 5px; color: var(--text-color); 
        }
        .pinyin { 
            color: #1E90FF !important; /* Xanh d∆∞∆°ng */
            font-family: "Courier New", monospace; 
            margin-bottom: 5px;
        }
        .english { 
            color: #2ecc71 !important; /* Xanh l√° */
            font-style: italic; 
            margin-bottom: 5px;
        }
        .second-language { 
            color: #e67e22 !important; /* Cam ƒë·∫≠m (Ti·∫øng Vi·ªát) */
            font-weight: 500;
        }

        /* Dark Mode Colors override */
        @media (prefers-color-scheme: dark) {
            .pinyin { color: #87CEEB !important; } /* Xanh tr·ªùi nh·∫°t */
            .english { color: #90EE90 !important; } /* Xanh l√° nh·∫°t */
            .second-language { color: #FFB6C1 !important; } /* H·ªìng nh·∫°t */
        }

        /* Interactive Mode Styles */
        .interactive-text {
            background: var(--block-bg);
            padding: 20px;
            border-radius: 12px;
            line-height: 2;
            font-size: 1.2rem;
        }

        .interactive-word {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.2s;
            border-bottom: 1px dotted #888;
        }
        .interactive-word:hover { background-color: rgba(30, 144, 255, 0.2); }

        /* Tooltip ƒë·∫πp */
        .interactive-word[data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%; left: 50%; transform: translateX(-50%);
            background-color: #2d3748; color: #fff;
            padding: 8px 12px; border-radius: 6px;
            font-size: 0.9rem; line-height: 1.4;
            white-space: pre; visibility: hidden; opacity: 0;
            transition: 0.2s; z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            pointer-events: none;
            min-width: 100px; text-align: center;
        }
        .interactive-word:hover:before { visibility: visible; opacity: 1; }

        /* Speech Controls */
        .speech-controls {
            position: sticky; top: 0; z-index: 100;
            background: var(--control-bg);
            padding: 15px; border-radius: 8px;
            display: flex; gap: 15px; flex-wrap: wrap;
            border: 1px solid var(--block-border);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .control-group { display: flex; align-items: center; gap: 10px; }
        label { white-space: nowrap; font-weight: bold; }
        
        select {
            padding: 5px; border-radius: 4px; 
            background: var(--bg-color); color: var(--text-color);
            border: 1px solid #ccc; max-width: 300px;
        }

        /* N√∫t loa */
        .speak-button {
            background: none; border: none; cursor: pointer;
            padding: 0 5px; vertical-align: middle;
        }
        .speak-button svg { width: 20px; height: 20px; fill: var(--text-color); opacity: 0.6; }
        .speak-button:hover svg { opacity: 1; fill: #1E90FF; }
    </style>

    <script>
        let synth = window.speechSynthesis;
        let voices = [];
        
        // --- LOGIC M·ªöI: NH·∫¨N NG√îN NG·ªÆ T·ª™ PYTHON ---
        // Bi·∫øn n√†y s·∫Ω ƒë∆∞·ª£c Python thay th·∫ø b·∫±ng m√£ ng√¥n ng·ªØ (vd: 'zh', 'vi')
        const TARGET_LANG_CODE = '{{voice_lang}}';

        function populateVoiceList() {
            if (typeof speechSynthesis === 'undefined') return;

            voices = synth.getVoices();
            let voiceSelect = document.getElementById('voice-language');
            voiceSelect.innerHTML = '';
            
            let defaultVoice = null;

            // L·ªçc gi·ªçng: Ch·ªâ hi·ªán gi·ªçng c√≥ ch·ª©a m√£ ng√¥n ng·ªØ ƒë√≠ch
            // (V√≠ d·ª•: N·∫øu d·ªãch sang Vi·ªát -> Ch·ªâ hi·ªán gi·ªçng Vi·ªát)
            // N·∫øu m√£ ng√¥n ng·ªØ r·ªóng ho·∫∑c kh√¥ng t√¨m th·∫•y, hi·ªán t·∫•t c·∫£.
            let filteredVoices = voices.filter(v => v.lang.includes(TARGET_LANG_CODE));
            if (filteredVoices.length === 0) filteredVoices = voices; // Fallback hi·ªán t·∫•t c·∫£

            // S·∫Øp x·∫øp ∆∞u ti√™n gi·ªçng Google/Microsoft
            filteredVoices.sort((a, b) => {
                const isGoogleA = a.name.includes('Google') || a.name.includes('Microsoft');
                const isGoogleB = b.name.includes('Google') || b.name.includes('Microsoft');
                return isGoogleB - isGoogleA; // True (1) l√™n ƒë·∫ßu
            });

            filteredVoices.forEach(voice => {
                let option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.setAttribute('data-name', voice.name);
                option.setAttribute('data-lang', voice.lang);
                
                // Ch·ªçn m·∫∑c ƒë·ªãnh gi·ªçng ƒë·∫ßu ti√™n (th∆∞·ªùng l√† gi·ªçng Google x·ªãn nh·∫•t do ƒë√£ sort)
                if (!defaultVoice) defaultVoice = voice;
                
                voiceSelect.appendChild(option);
            });
            
            // Set gi·ªçng m·∫∑c ƒë·ªãnh v√†o th·∫ª Select
            if (defaultVoice) {
                // T√¨m index c·ªßa defaultVoice trong select
                // (Code ƒë∆°n gi·∫£n: c·ª© ƒë·ªÉ m·∫∑c ƒë·ªãnh l√† c√°i ƒë·∫ßu ti√™n)
                voiceSelect.selectedIndex = 0; 
            }
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }

        function speak(text) {
            if (synth.speaking) synth.cancel();
            if (!text) return;

            const utterance = new SpeechSynthesisUtterance(text);
            const voiceSelect = document.getElementById('voice-language');
            
            if (voiceSelect.selectedOptions.length > 0) {
                const selected = voiceSelect.selectedOptions[0];
                const voice = voices.find(v => 
                    v.name === selected.getAttribute('data-name') && 
                    v.lang === selected.getAttribute('data-lang')
                );
                if (voice) utterance.voice = voice;
            }
            
            utterance.rate = document.getElementById('voice-speed').value;
            synth.speak(utterance);
        }

        // H√†m g·ªçi t·ª´ n√∫t loa (L·ªçc b·ªè icon)
        function speakSentence(text) {
            speak(text.replace('üîä', '').trim());
        }

        // Load l·∫°i gi·ªçng sau 0.5s ƒë·ªÉ ch·∫Øc ch·∫Øn
        window.onload = function() {
            populateVoiceList();
            setTimeout(populateVoiceList, 500);
        };
    </script>
</head>

<body>
    <div class="speech-controls">
        <div class="control-group">
            <label for="voice-language">Voice:</label>
            <select id="voice-language"><option>Loading...</option></select>
        </div>
        <div class="control-group">
            <label for="voice-speed">Speed:</label>
            <input type="range" id="voice-speed" min="0.5" max="2" step="0.1" value="1">
        </div>
    </div>
    
    <div id="content-area">
        {{content}}
    </div>
</body>
</html>
